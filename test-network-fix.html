<!DOCTYPE html>
<html>
<head>
    <title>Network Error Fix Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
            border: 1px solid #ccc;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Network Error Fix Verification</h1>
    
    <div>
        <button onclick="testAuthEndpoints()">Test Auth Endpoints</button>
        <button onclick="testShiftEndpoints()">Test Shift Endpoints</button>
        <button onclick="testLocationEndpoints()">Test Location Endpoints</button>
        <button onclick="runAllNetworkTests()">Run All Tests</button>
    </div>
    
    <div id="results"></div>

    <script>
        const BACKEND_URL = 'http://localhost:5000';
        
        function addResult(title, content, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.innerHTML = `<h3>${title}</h3>${content}`;
            resultsDiv.appendChild(resultDiv);
        }
        
        async function testAuthEndpoints() {
            addResult('üîê Testing Auth Endpoints', 'Testing registration and login...', 'info');
            
            // Test registration
            try {
                const testUser = {
                    username: `testuser_${Date.now()}`,
                    password: 'testpass123',
                    role: 'care_worker'
                };
                
                const regResponse = await fetch(`${BACKEND_URL}/api/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testUser)
                });
                
                if (!regResponse.ok) {
                    const errorData = await regResponse.json();
                    throw new Error(errorData.error || 'Registration failed');
                }
                
                const regData = await regResponse.json();
                
                // Test login with the same user
                const loginResponse = await fetch(`${BACKEND_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: testUser.username,
                        password: testUser.password
                    })
                });
                
                if (!loginResponse.ok) {
                    const errorData = await loginResponse.json();
                    throw new Error(errorData.error || 'Login failed');
                }
                
                const loginData = await loginResponse.json();
                
                addResult('‚úÖ Auth Endpoints Working', `
                    <p><strong>Registration:</strong> Success (User ID: ${regData.user.id})</p>
                    <p><strong>Login:</strong> Success (User: ${loginData.user.username})</p>
                    <p><strong>Network Error:</strong> FIXED</p>
                `, 'success');
                
            } catch (error) {
                addResult('‚ùå Auth Endpoints Failed', `
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p><strong>Network Error:</strong> Still present</p>
                `, 'error');
            }
        }
        
        async function testShiftEndpoints() {
            addResult('‚è∞ Testing Shift Endpoints', 'Testing shift operations...', 'info');
            
            try {
                // Test get all shifts
                const shiftsResponse = await fetch(`${BACKEND_URL}/api/shifts`);
                
                if (!shiftsResponse.ok) {
                    throw new Error('Failed to fetch shifts');
                }
                
                const shiftsData = await shiftsResponse.json();
                
                // Test get active shifts
                const activeResponse = await fetch(`${BACKEND_URL}/api/shifts?activeOnly=true`);
                
                if (!activeResponse.ok) {
                    throw new Error('Failed to fetch active shifts');
                }
                
                const activeData = await activeResponse.json();
                
                addResult('‚úÖ Shift Endpoints Working', `
                    <p><strong>All Shifts:</strong> Retrieved ${shiftsData.shifts.length} shifts</p>
                    <p><strong>Active Shifts:</strong> Retrieved ${activeData.shifts.length} active shifts</p>
                    <p><strong>Network Error:</strong> FIXED</p>
                `, 'success');
                
            } catch (error) {
                addResult('‚ùå Shift Endpoints Failed', `
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p><strong>Network Error:</strong> Still present</p>
                `, 'error');
            }
        }
        
        async function testLocationEndpoints() {
            addResult('üìç Testing Location Endpoints', 'Testing location operations...', 'info');
            
            try {
                // Test get perimeter
                const perimeterResponse = await fetch(`${BACKEND_URL}/api/location/perimeter`);
                
                if (!perimeterResponse.ok) {
                    throw new Error('Failed to fetch location perimeter');
                }
                
                const perimeterData = await perimeterResponse.json();
                
                addResult('‚úÖ Location Endpoints Working', `
                    <p><strong>Perimeter:</strong> Lat: ${perimeterData.perimeter.latitude}, Lng: ${perimeterData.perimeter.longitude}</p>
                    <p><strong>Radius:</strong> ${perimeterData.perimeter.radius} meters</p>
                    <p><strong>Network Error:</strong> FIXED</p>
                `, 'success');
                
            } catch (error) {
                addResult('‚ùå Location Endpoints Failed', `
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p><strong>Network Error:</strong> Still present</p>
                `, 'error');
            }
        }
        
        async function runAllNetworkTests() {
            document.getElementById('results').innerHTML = '';
            addResult('üöÄ Running Network Error Fix Tests', 'Testing all fixed endpoints...', 'info');
            
            await testAuthEndpoints();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testShiftEndpoints();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testLocationEndpoints();
            
            addResult('üéâ Network Tests Completed', 'All network connectivity tests finished. Check results above.', 'success');
        }
        
        // Auto-run test on page load
        window.onload = function() {
            addResult('üîß Network Error Fixes Applied', `
                <p>‚úÖ Added missing 'await' keywords in Login components</p>
                <p>‚úÖ Added missing 'await' keywords in Register components</p>
                <p>‚úÖ Fixed async loadData function in Dashboard</p>
                <p>‚úÖ Updated ShiftService to use backend API instead of localStorage</p>
                <p>‚úÖ Verified backend server is running on port 5000</p>
                <p>‚úÖ Verified CORS configuration is correct</p>
            `, 'info');
        };
    </script>
</body>
</html>
